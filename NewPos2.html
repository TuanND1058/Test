<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Textarea Functions</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js" integrity="sha512-YHQNqPhxuCY2ddskIbDlZfwY6Vx3L3w9WRbyJCY81xpqLmrM6rL2+LocBgeVHwGY9SXYfQWJ+lcEWx1fKS2s8A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

</head>
<style>
body{
    font-size: 12px;
}

.non-resize-textarea {
    overflow: hidden;
    resize: none;
    line-height: 1.929;
    height: 33px;
}

.preview {
    position: sticky;
    top: 15px;
    max-height: 500px;
    overflow-y: auto;
    text-align: center;
    border: 1px solid gray;
    padding: 5px 10px;
}

textarea {
    font-family: 'Courier New', Courier, monospace;
}

table, th, td {
    border: 1px solid black;
    border-collapse: collapse;
}

td {
    padding: 0 5px;
}

pre {
    font-family: 'Courier New', Courier, monospace;
    display: block;
    padding: 0;
    margin: 0;
    font-size: 14px;
    border: transparent;
    background-color: transparent;
    line-height: 1.1;
    overflow: hidden;
    width: 100%;
}

.hl-normal {

}

.hl-bold {
    font-weight: bold;
}

.hl-double-h {
    transform: scaleY(2);
    transform-origin: top;
    margin-bottom: 12px;
}

.hl-double-w {
    transform: scaleX(2);
    transform-origin: left;
    width: 50%;
}

.hl-double-wh {
    transform: scale(2);
    transform-origin: top left;
    width: 50%;
    margin-bottom: 12px;
}

label {
    margin: 0;
}

label:has(input[type="radio"]:disabled) {
    color: #797979;
}
</style>
<body>

<br>

<div class="container">
<div class="row">
    <div class="col-md-8" style="background-color: #dddddd;">
        <div class="row">
            <div class="col-md-5">
                <div style="margin-bottom: 23px;">Print Line</div>
                <textarea class="non-resize-textarea" id="txtInputText" rows="1" cols="41"></textarea>
            </div>
            <div class="col-md-7" style="background-color: #ffc9c9;">
                <table id="tblOptions">
                    <thead>
                        <tr>
                            <th>
                                Alignment
                                <br/>
                                <label><input type="radio" name="alignmentAll" value="0">Left</label>
                                <label><input type="radio" name="alignmentAll" value="1">Center</label>
                                <label><input type="radio" name="alignmentAll" value="2">Right</label>
                            </th>
                            <th>
                                Highlight
                                <br>
                                <select name="highlightAll" id="highlightAll">
                                    <option value="">---</option>
                                    <option value="0">Normal</option>
                                    <option value="1">Bold</option>
                                    <option value="2">DoubleH</option>
                                    <option value="3">DoubleW</option>
                                    <option value="4">DoubleWH</option>
                                </select>
                            </th>
                            <th>
                                Etc
                                <br>
                                <select name="etcAll" id="etcAll">
                                    <option value="">---</option>
                                    <option value="0">Normal</option>
                                    <option value="1">Gift Code</option>
                                    <option value="2">Barcode</option>
                                </select>
                            </th>
                            <th>
                                EJS
                                <br>
                                <select name="ejsAll" id="ejsAll">
                                    <option value="">---</option>
                                    <option value="0">Normal</option>
                                    <option value="1">None</option>
                                    <option value="2">EJS only</option>
                                </select>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="seq001" data-seq="001">
                            <td>
                                <label><input type="radio" name="alignment001" value="0" checked>Left</label>
                                <label><input type="radio" name="alignment001" value="1">Center</label>
                                <label><input type="radio" name="alignment001" value="2">Right</label>
                            </td>
                            <td>
                                <select name="highlight001" id="highlight001">
                                    <option value="0" selected>Normal</option>
                                    <option value="1">Bold</option>
                                    <option value="2">DoubleH</option>
                                    <option value="3">DoubleW</option>
                                    <option value="4">DoubleWH</option>
                                </select>
                            </td>
                            <td>
                                <select name="etc001" id="etc001">
                                    <option value="0" selected>Normal</option>
                                    <option value="1">Gift Code</option>
                                    <option value="2">Barcode</option>
                                </select>
                            </td>
                            <td>
                                <select name="ejs001" id="ejs001">
                                    <option value="0" selected>Normal</option>
                                    <option value="1">None</option>
                                    <option value="2">EJS only</option>
                                </select>
                            </td>
                        </tr>
                        <tr id="seq002" data-seq="002">
                            <td>
                                <label><input type="radio" name="alignment002" value="0" checked>Left</label>
                                <label><input type="radio" name="alignment002" value="1">Center</label>
                                <label><input type="radio" name="alignment002" value="2">Right</label>
                            </td>
                            <td>
                                <select name="highlight002" id="highlight002">
                                    <option value="0" selected>Normal</option>
                                    <option value="1">Bold</option>
                                    <option value="2">DoubleH</option>
                                    <option value="3">DoubleW</option>
                                    <option value="4">DoubleWH</option>
                                </select>
                            </td>
                            <td>
                                <select name="etc002" id="etc002">
                                    <option value="0" selected>Normal</option>
                                    <option value="1">Gift Code</option>
                                    <option value="2">Barcode</option>
                                </select>
                            </td>
                            <td>
                                <select name="ejs002" id="ejs002">
                                    <option value="0" selected>Normal</option>
                                    <option value="1">None</option>
                                    <option value="2">EJS only</option>
                                </select>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="divPreview" class="col-md-4 preview">
        <pre>태그의 각 줄 미리보기</pre>
        <pre>태그의 각 줄 미리보기</pre>
    </div>
</div>
</div>

<script>

// initialize common variable
var barcode = '[barcode]';
var sizePerLine = 40;
var printLines = [];
var optionAll = {
    alignment: '',
    highlight: '',
    etc: '',
    ejs: ''
};
var editingInfo = {
    previousLine: 1,
    currentLine: 1,
    rowCount: 1
};
var dataDetail = [
    {
        seq: '001',
        textOrigin: '',
        buffer: ' ',
        alignment: '0',
        highlight: '0',
        etc: '0',
        ejs: '0'
    }
];

$(document).ready(function(){

    // call the function to update the table with the initial preview
    fnRenderRowHeadTable('#tblOptions thead');
    fnRenderRowBodyTable('#tblOptions tbody');
    fnRenderPreviewDetail('#divPreview');

    $('#txtInputText').on('input', function() {
        fnAutoNewlines('#txtInputText');

        fnSetEditingInfo('#txtInputText');

        fnRenderRowBodyTable('#tblOptions tbody');

        fnRenderPreviewDetail('#divPreview');

        console.log(dataDetail);
    });

    $('#tblOptions thead').on('change', 'input[type="radio"], select', function() {
        var row = $(this).closest('tr');

        fnUpdateAllOptionsDetail(row);

        fnUpdateAllRowDetailTable(row);

        fnRenderRowBodyTable('#tblOptions tbody');

        fnRenderPreviewDetail('#divPreview');

        console.log(dataDetail);
    });

    $('#tblOptions tbody').on('change', 'input[type="radio"], select', function() {
        var row = $(this).closest('tr');

        fnUpdateOptionsDetail(row);

        fnUpdateRowDetailTable(row);

        fnRenderRowHeadTable('#tblOptions thead');

        fnRenderPreviewDetail('#divPreview');

        console.log(dataDetail);
    });

    $('#txtInputText').on('click', function() {
        var currentLine = fnGetCaretPosition('#txtInputText');
        editingInfo.previousLine = currentLine;
        editingInfo.currentLine = currentLine;
    });

});

///
/// debounce
///
function debounce(func, delay) {
    var timer;
    return function() {
        var context = this;
        var args = arguments;
        clearTimeout(timer);
        timer = setTimeout(() => {
            func.apply(context, args);
        }, delay);
    };
}

///
/// fnUpdateAllOptionsDetail
///
function fnUpdateAllOptionsDetail(row) {
    var alignmentAll = row.find('input[type="radio"]:checked').val();
    var highlightAll = row.find('select').eq(0).val();
    var etcAll = row.find('select').eq(1).val();
    var ejsAll = row.find('select').eq(2).val();

    optionAll.alignment = alignmentAll;
    optionAll.highlight = highlightAll;
    optionAll.etc = etcAll;
    optionAll.ejs = ejsAll;

    dataDetail.forEach(function(data) {
        var textFormat = fnFormatText(data.textOrigin, alignmentAll, highlightAll, sizePerLine);

        data.textOrigin = textFormat.textOrigin;
        data.buffer = textFormat.text;
        data.alignment = alignmentAll || '0';
        data.highlight = highlightAll || '0';
        data.etc = etcAll || '0';
        data.ejs = ejsAll || '0';
    });
}
function fnUpdateAllOptionsDetailOld(row) {
    // get element row detail
    var alignmentAllElement = row.find('input[type="radio"]');
    var highlightAllElement = row.find('select').eq(0);
    var etcAllElement = row.find('select').eq(1);
    var ejsAllElement = row.find('select').eq(2);

    // get value
    var alignmentAll = alignmentAllElement.filter(':checked').val();
    var highlightAll = highlightAllElement.val();
    var etcAll = etcAllElement.val();
    var ejsAll = ejsAllElement.val();

    optionAll.alignment = alignmentAll;
    optionAll.highlight = highlightAll;
    optionAll.etc = etcAll;
    optionAll.ejs = ejsAll;

    dataDetail.forEach(function(data) {
        data.alignment = optionAll.alignment || '0';
        data.highlight = optionAll.highligh || '0';
        data.etc = optionAll.etc || '0';
        data.ejs = optionAll.ejs || '0';

        var textFormat = fnFormatText(data.textOrigin, optionAll.alignment, optionAll.highlight, sizePerLine);

        data.textOrigin = textFormat.textOrigin;
        data.buffer = textFormat.text;
    });
}

///
/// fnUpdateOptionsDetail : updated text formatting options in data array
///
function fnUpdateOptionsDetail(row) {
    // Get elements for row detail only once
    var alignmentElement = row.find('input[type="radio"]');
    var highlightElement = row.find('select').eq(0);
    var etcElement = row.find('select').eq(1);
    var ejsElement = row.find('select').eq(2);

    // Get values of elements
    var alignment = alignmentElement.filter(':checked').val();
    var highlight = highlightElement.val();
    var etc = etcElement.val();
    var ejs = ejsElement.val();

    // Reset options in optionAll if necessary
    if (optionAll.alignment && optionAll.alignment !== alignment) {
        optionAll.alignment = '';
    }
    if (optionAll.highlight && optionAll.highlight !== highlight) {
        optionAll.highlight = '';
    }
    if (optionAll.etc && optionAll.etc !== etc) {
        optionAll.etc = '';
    }
    if (optionAll.ejs && optionAll.ejs !== ejs) {
        optionAll.ejs = '';
    }

    var seq = row.data("seq");
    var data = dataDetail.find(item => item.seq === seq);

    // Update dataDetail array
    var textFormat = fnFormatText(data.textOrigin, alignment, highlight, sizePerLine);
    data.textOrigin = textFormat.textOrigin;
    data.buffer = textFormat.text;
    data.alignment = alignment || '0';
    data.highlight = highlight || '0';
    data.etc = etc || '0';
    data.ejs = ejs || '0';
}
function fnUpdateOptionsDetailOld(row) {
    // get element row detail
    var alignmentElement = row.find('input[type="radio"]');
    var highlightElement = row.find('select').eq(0);
    var etcElement = row.find('select').eq(1);
    var ejsElement = row.find('select').eq(2);

    // get value
    var alignment = alignmentElement.filter(':checked').val();
    var highlight = highlightElement.val();
    var etc = etcElement.val();
    var ejs = ejsElement.val();

    // reset option all
    if (optionAll.alignment && optionAll.alignment !== alignment) {
        optionAll.alignment = '';
    }
    if (optionAll.highlight && optionAll.highlight !== highlight) {
        optionAll.highlight = '';
    }
    if (optionAll.etc && optionAll.etc !== etc) {
        optionAll.etc = '';
    }
    if (optionAll.ejs && optionAll.ejs !== ejs) {
        optionAll.ejs = '';
    }

    var seq = row.data("seq");
    var data = dataDetail.find(item => item.seq === seq);
    var textFormat = fnFormatText(data.textOrigin, alignment, highlight, sizePerLine);

    data.textOrigin = textFormat.textOrigin;
    data.buffer = textFormat.text;
    data.alignment = alignment || '0';
    data.highlight = highlight || '0';
    data.etc = etc || '0';
    data.ejs = ejs || '0';
}

///
/// fnUpdateAllRowDetailTable : updated status for row
///
function fnUpdateAllRowDetailTable(row) {
    // Get elements for all rows only once
    var alignmentAllElement = row.find('input[type="radio"]');
    var highlightAllElement = row.find('select').eq(0);
    var etcAllElement = row.find('select').eq(1);
    var ejsAllElement = row.find('select').eq(2);

    // Get values of all elements
    var alignmentAll = alignmentAllElement.filter(':checked').val();
    var highlightAll = highlightAllElement.val();
    var etcAll = etcAllElement.val();
    var ejsAll = ejsAllElement.val();

    // Set enable options for all elements
    alignmentAllElement.prop('disabled', false);
    highlightAllElement.prop('disabled', false);

    // Disable options for all rows if etcAll is '1' or '2'
    if (etcAll === '1' || etcAll === '2') {
        alignmentAllElement.prop('disabled', true);
        highlightAllElement.prop('disabled', true);
    }

    // Update dataDetail array based on selected values
    dataDetail.forEach(function(data) {
        data.alignment = etcAll === '1' ? '1' : (alignmentAll || '0');
        data.highlight = etcAll === '1' ? '0' : (highlightAll || '0');
        data.etc = etcAll || '0';
        data.ejs = ejsAll || '0';

        // Handle specific cases for '1' (Gift Code) and '2' (Barcode)
        if (etcAll === '1') {
            data.highlight = '0';
        } else if (etcAll === '2') {
            data.buffer = barcode;
            data.highlight = '0';
        }
    });
}
function fnUpdateAllRowDetailTableOld(row) {
    // get element row detail
    var alignmentAllElement = row.find('input[type="radio"]');
    var highlightAllElement = row.find('select').eq(0);
    var etcAllElement = row.find('select').eq(1);
    var ejsAllElement = row.find('select').eq(2);

    // get value
    var alignmentAll = alignmentAllElement.filter(':checked').val();
    var highlightAll = highlightAllElement.val();
    var etcAll = etcAllElement.val();
    var ejsAll = ejsAllElement.val();

    // set enable options
    alignmentAllElement.prop('disabled', false);
    highlightAllElement.prop('disabled', false);

    // gift code
    if (etcAll === '1') {
        alignmentAllElement.prop('disabled', true);
        highlightAllElement.prop('disabled', true);
    }

    // barcode
    if (etcAll === '2') {
        alignmentAllElement.prop('disabled', true);
        highlightAllElement.prop('disabled', true);
    }

    dataDetail.forEach(function(data) {
        data.alignment = alignmentAll || '0';
        data.highlight = highlightAll || '0';
        data.etc = etcAll || '0';
        data.ejs = ejsAll || '0';

        // gift code
        if (etcAll === '1') {
            data.alignment = '1';
            data.highlight = '0';
        }

        // barcode
        if (etcAll === '2') {
            data.buffer = barcode;
            data.highlight = '0';
        }
    });
}

///
/// fnUpdateRowDetailTable : updated status for row
///
function fnUpdateRowDetailTable(row) {
    // Get element row detail only once
    var alignmentElement = row.find('input[type="radio"]');
    var highlightElement = row.find('select').eq(0);
    var etcElement = row.find('select').eq(1);

    // Get value of etc and seq attributes
    var etc = etcElement.val();
    var seq = row.data("seq");

    var data = dataDetail.find(item => item.seq === seq);

    // Set enable options for alignment and highlight elements
    alignmentElement.prop('disabled', false);
    highlightElement.prop('disabled', false);

    // Optimize conditionals by combining similar ones
    if (etc === '1' || etc === '2') {
        // Disable alignment and highlight elements
        alignmentElement.prop('disabled', true);
        highlightElement.prop('disabled', true);

        // Update data based on etc value
        if (etc === '1') {
            var textFormat = fnFormatText(data.textOrigin, '1', '0', sizePerLine);
            data.buffer = textFormat.text;
            data.alignment = '1';
            data.highlight = '0';
        } else if (etc === '2') {
            data.buffer = barcode;
            data.highlight = '0';
        }
    }
}
function fnUpdateRowDetailTableOld(row) {
    // get element row detail
    var alignmentElement = row.find('input[type="radio"]');
    var highlightElement = row.find('select').eq(0);
    var etcElement = row.find('select').eq(1);
    var ejsElement = row.find('select').eq(2);

    // get value
    var etc = etcElement.val();

    var seq = row.data("seq");

    var data = dataDetail.find(item => item.seq === seq);

    // set enable options
    alignmentElement.prop('disabled', false);
    highlightElement.prop('disabled', false);

    // gift code
    if (etc === '1') {
        alignmentElement.prop('disabled', true);
        highlightElement.prop('disabled', true);

        data.alignment = '1';
        data.highlight = '0';
    }

    // barcode
    if (etc === '2') {
        alignmentElement.prop('disabled', true);
        highlightElement.prop('disabled', true);

        data.buffer = barcode;
        data.highlight = '0';
    }
}

///
/// fnRenderRowHeadTable : create a table containing text format options
///
function fnRenderRowHeadTable(idElement) {
    var container = $(idElement);
    container.empty();

    var newRow = $('<tr>');

    newRow.append(
        '<td>Alignment<br/>' +
            '<label><input type="radio" name="alignmentAll" value="0" ' + (optionAll.alignment === '0' ? 'checked' : '') + ' ' + (optionAll.etc && optionAll.etc !== '0' ? 'disabled' : '') + '>Left</label>' +
            '<label><input type="radio" name="alignmentAll" value="1" ' + (optionAll.alignment === '1' ? 'checked' : '') + ' ' + (optionAll.etc && optionAll.etc !== '0' ? 'disabled' : '') + '>Center</label>' +
            '<label><input type="radio" name="alignmentAll" value="2" ' + (optionAll.alignment === '2' ? 'checked' : '') + ' ' + (optionAll.etc && optionAll.etc !== '0' ? 'disabled' : '') + '>Right</label>' +
        '</td>' +
        '<td>Highlight<br/>' +
            '<select name="highlightAll" ' + (optionAll.etc && optionAll.etc !== '0' ? 'disabled' : '') + '>' +
                '<option value="" ' + (optionAll.highlight === '' ? 'selected' : '') + '>---</option>' +
                '<option value="0" ' + (optionAll.highlight === '0' ? 'selected' : '') + '>Normal</option>' +
                '<option value="1" ' + (optionAll.highlight === '1' ? 'selected' : '') + '>Bold</option>' +
                '<option value="2" ' + (optionAll.highlight === '2' ? 'selected' : '') + '>DoubleH</option>' +
                '<option value="3" ' + (optionAll.highlight === '3' ? 'selected' : '') + '>DoubleW</option>' +
                '<option value="4" ' + (optionAll.highlight === '4' ? 'selected' : '') + '>DoubleWH</option>' +
            '</select>' +
        '</td>' +
        '<td>Etc<br/>' +
            '<select name="etcAll">' +
                '<option value="" ' + (optionAll.etc === '' ? 'selected' : '') + '>---</option>' +
                '<option value="0" ' + (optionAll.etc === '0' ? 'selected' : '') + '>Normal</option>' +
                '<option value="1" ' + (optionAll.etc === '1' ? 'selected' : '') + '>Gift Code</option>' +
                '<option value="2" ' + (optionAll.etc === '2' ? 'selected' : '') + '>Barcode</option>' +
            '</select>' +
        '</td>' +
        '<td>EJS<br/>' +
            '<select name="ejsAll">' +
                '<option value="" ' + (optionAll.ejs === '' ? 'selected' : '') + '>---</option>' +
                '<option value="0" ' + (optionAll.ejs === '0' ? 'selected' : '') + '>Normal</option>' +
                '<option value="1" ' + (optionAll.ejs === '1' ? 'selected' : '') + '>None</option>' +
                '<option value="2" ' + (optionAll.ejs === '2' ? 'selected' : '') + '>EJS only</option>' +
            '</select>' +
        '</td>'
    );

    container.append(newRow);
}
function fnRenderRowHeadTableOld(idElement) {
    $(idElement).empty();

    var data = optionAll;

    var newRow = '' +
        '<tr>' +
            '<td>Alignment<br/>' +
                '<label><input type="radio" name="alignmentAll" value="0" ' + (optionAll.alignment === '0' ? 'checked' : '') + ' ' + (optionAll.etc && data.etc !== '0' ? 'disabled' : '') + '>Left</label>' +
                '<label><input type="radio" name="alignmentAll" value="1" ' + (optionAll.alignment === '1' ? 'checked' : '') + ' ' + (optionAll.etc && data.etc !== '0' ? 'disabled' : '') + '>Center</label>' +
                '<label><input type="radio" name="alignmentAll" value="2" ' + (optionAll.alignment === '2' ? 'checked' : '') + ' ' + (optionAll.etc && data.etc !== '0' ? 'disabled' : '') + '>Right</label>' +
            '</td>' +
            '<td>Highlight<br/>' +
                '<select name="highlightAll" ' + (optionAll.etc && optionAll.etc !== '0' ? 'disabled' : '') + '>' +
                    '<option value="" ' + (optionAll.highlight === '' ? 'selected' : '') + '>---</option>' +
                    '<option value="0" ' + (optionAll.highlight === '0' ? 'selected' : '') + '>Normal</option>' +
                    '<option value="1" ' + (optionAll.highlight === '1' ? 'selected' : '') + '>Bold</option>' +
                    '<option value="2" ' + (optionAll.highlight === '2' ? 'selected' : '') + '>DoubleH</option>' +
                    '<option value="3" ' + (optionAll.highlight === '3' ? 'selected' : '') + '>DoubleW</option>' +
                    '<option value="4" ' + (optionAll.highlight === '4' ? 'selected' : '') + '>DoubleWH</option>' +
                '</select>' +
            '</td>' +
            '<td>Etc<br/>' +
                '<select name="etcAll">' +
                    '<option value="" ' + (optionAll.etc === '' ? 'selected' : '') + '>---</option>' +
                    '<option value="0" ' + (optionAll.etc === '0' ? 'selected' : '') + '>Normal</option>' +
                    '<option value="1" ' + (optionAll.etc === '1' ? 'selected' : '') + '>Gift Code</option>' +
                    '<option value="2" ' + (optionAll.etc === '2' ? 'selected' : '') + '>Barcode</option>' +
                '</select>' +
            '</td>' +
            '<td>EJS<br/>' +
                '<select name="ejsAll">' +
                    '<option value="" ' + (optionAll.ejs === '' ? 'selected' : '') + '>---</option>' +
                    '<option value="0" ' + (optionAll.ejs === '0' ? 'selected' : '') + '>Normal</option>' +
                    '<option value="1" ' + (optionAll.ejs === '1' ? 'selected' : '') + '>None</option>' +
                    '<option value="2" ' + (optionAll.ejs === '2' ? 'selected' : '') + '>EJS only</option>' +
                '</select>' +
            '</td>' +
        '</tr>';

    $(idElement).append(newRow);
}

///
/// fnRenderRowTable : create a table containing text format options
///
function fnRenderRowBodyTable(idElement) {
    var container = $(idElement);
    container.empty();

    var htmlContent = '';

    dataDetail.forEach(function(data) {
        htmlContent += '<tr id="seq' + data.seq + '" data-seq="' + data.seq + '">' +
            '<td>' +
                '<label><input type="radio" name="alignment' + data.seq + '" value="0" ' + (data.alignment === '0' ? 'checked' : '') + ' ' + (data.etc !== '0' ? 'disabled' : '') + '>Left</label>' +
                '<label><input type="radio" name="alignment' + data.seq + '" value="1" ' + (data.alignment === '1' ? 'checked' : '') + ' ' + (data.etc !== '0' ? 'disabled' : '') + '>Center</label>' +
                '<label><input type="radio" name="alignment' + data.seq + '" value="2" ' + (data.alignment === '2' ? 'checked' : '') + ' ' + (data.etc !== '0' ? 'disabled' : '') + '>Right</label>' +
            '</td>' +
            '<td>' +
                '<select name="highlight' + data.seq + '" ' + (data.etc !== '0' ? 'disabled' : '') + '>' +
                    '<option value="0" ' + (data.highlight === '0' ? 'selected' : '') + '>Normal</option>' +
                    '<option value="1" ' + (data.highlight === '1' ? 'selected' : '') + '>Bold</option>' +
                    '<option value="2" ' + (data.highlight === '2' ? 'selected' : '') + '>DoubleH</option>' +
                    '<option value="3" ' + (data.highlight === '3' ? 'selected' : '') + '>DoubleW</option>' +
                    '<option value="4" ' + (data.highlight === '4' ? 'selected' : '') + '>DoubleWH</option>' +
                '</select>' +
            '</td>' +
            '<td>' +
                '<select name="etc' + data.seq + '">' +
                    '<option value="0" ' + (data.etc === '0' ? 'selected' : '') + '>Normal</option>' +
                    '<option value="1" ' + (data.etc === '1' ? 'selected' : '') + '>Gift Code</option>' +
                    '<option value="2" ' + (data.etc === '2' ? 'selected' : '') + '>Barcode</option>' +
                '</select>' +
            '</td>' +
            '<td>' +
                '<select name="ejs' + data.seq + '">' +
                    '<option value="0" ' + (data.ejs === '0' ? 'selected' : '') + '>Normal</option>' +
                    '<option value="1" ' + (data.ejs === '1' ? 'selected' : '') + '>None</option>' +
                    '<option value="2" ' + (data.ejs === '2' ? 'selected' : '') + '>EJS only</option>' +
                '</select>' +
            '</td>' +
        '</tr>';
    });

    container.append(htmlContent);
}
function fnRenderRowBodyTableOld(idElement) {
    $(idElement).empty();

    // loop through the array and add new rows to the table
    dataDetail.forEach(function(data) {
        var newRow = '' +
            '<tr id="seq' + data.seq + '" data-seq="' + data.seq + '">' +
                '<td>' +
                    '<label><input type="radio" name="alignment' + data.seq + '" value="0" ' + (data.alignment === '0' ? 'checked' : '') + ' ' + (data.etc !== '0' ? 'disabled' : '') + '>Left</label>' +
                    '<label><input type="radio" name="alignment' + data.seq + '" value="1" ' + (data.alignment === '1' ? 'checked' : '') + ' ' + (data.etc !== '0' ? 'disabled' : '') + '>Center</label>' +
                    '<label><input type="radio" name="alignment' + data.seq + '" value="2" ' + (data.alignment === '2' ? 'checked' : '') + ' ' + (data.etc !== '0' ? 'disabled' : '') + '>Right</label>' +
                '</td>' +
                '<td>' +
                    '<select name="highlight' + data.seq + '" ' + (data.etc !== '0' ? 'disabled' : '') + '>' +
                        '<option value="0" ' + (data.highlight === '0' ? 'selected' : '') + '>Normal</option>' +
                        '<option value="1" ' + (data.highlight === '1' ? 'selected' : '') + '>Bold</option>' +
                        '<option value="2" ' + (data.highlight === '2' ? 'selected' : '') + '>DoubleH</option>' +
                        '<option value="3" ' + (data.highlight === '3' ? 'selected' : '') + '>DoubleW</option>' +
                        '<option value="4" ' + (data.highlight === '4' ? 'selected' : '') + '>DoubleWH</option>' +
                    '</select>' +
                '</td>' +
                '<td>' +
                    '<select name="etc' + data.seq + '">' +
                        '<option value="0" ' + (data.etc === '0' ? 'selected' : '') + '>Normal</option>' +
                        '<option value="1" ' + (data.etc === '1' ? 'selected' : '') + '>Gift Code</option>' +
                        '<option value="2" ' + (data.etc === '2' ? 'selected' : '') + '>Barcode</option>' +
                    '</select>' +
                '</td>' +
                '<td>' +
                    '<select name="ejs' + data.seq + '">' +
                        '<option value="0" ' + (data.ejs === '0' ? 'selected' : '') + '>Normal</option>' +
                        '<option value="1" ' + (data.ejs === '1' ? 'selected' : '') + '>None</option>' +
                        '<option value="2" ' + (data.ejs === '2' ? 'selected' : '') + '>EJS only</option>' +
                    '</select>' +
                '</td>' +
            '</tr>';

        $(idElement).append(newRow);
    });
}

///
/// fnRenderPreviewDetail : create a <pre> tag for the preview
///
function fnRenderPreviewDetail(idElement) {
    var previewDiv = $(idElement);
    previewDiv.empty();

    var highlightClasses = {
        '0': 'hl-normal',
        '1': 'hl-bold',
        '2': 'hl-double-h',
        '3': 'hl-double-w',
        '4': 'hl-double-wh'
    };

    dataDetail.forEach(function(data) {
        var preElement = $('<pre>').text(data.buffer || ' ');

        if (highlightClasses[data.highlight]) {
            preElement.addClass(highlightClasses[data.highlight]);
        }

        previewDiv.append(preElement);
    });
}
function fnRenderPreviewDetailOld(idElement) {
    var previewDiv = $(idElement);
    previewDiv.empty();

    dataDetail.forEach(function(data) {
        var preElement = $('<pre>').text(data.buffer || ' ');

        switch (data.highlight) {
            case '0':
                preElement.addClass('hl-normal');
                break;
            case '1':
                preElement.addClass('hl-bold');
                break;
            case '2':
                preElement.addClass('hl-double-h');
                break;
            case '3':
                preElement.addClass('hl-double-w');
                break;
            case '4':
                preElement.addClass('hl-double-wh');
                break;
            default:
                break;
        }

        previewDiv.append(preElement);
    });
}

///
/// fnGetCaretPosition : function to get cursor position
///
function fnGetCaretPosition(id) {
    var textarea = $(id);
    var text = textarea.val();
    var selectionPos = textarea[0].selectionStart;
    var currentLine = text.substring(0, selectionPos).split('\n').length;
    return currentLine;
}

///
/// fnAutoNewline : automatically wrap text when limit is reached
///
function fnAutoNewlines(idElement) {
    var textarea = $(idElement);
    var text = textarea.val();
    var selectionPos = textarea[0].selectionStart;
    var maxLength = sizePerLine;
    var lines = text.split('\n');

    for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        var cutTextSize = fnCutTextSize(line).text;
        maxLength = cutTextSize.length;

        // automatically breaks the line after the limit is reached
        if (line.length > maxLength) {
            var spacePos = line.lastIndexOf(' ', maxLength);

            if (spacePos !== -1) {
                lines[i] = line.substring(0, spacePos);
                lines.splice(i + 1, 0, line.substring(spacePos + 1));
            } else {
                lines[i] = line.substring(0, maxLength);
                lines.splice(i + 1, 0, line.substring(maxLength));
            }
        }
    }

    printLines = lines;

    var updatedText = lines.join('\n');
    textarea.val(updatedText);
    textarea.css('height', 'auto').height(textarea[0].scrollHeight);

    // restore cursor position
    textarea[0].setSelectionRange(selectionPos, selectionPos);

    // set current line after update
    editingInfo.currentLine = fnGetCaretPosition(idElement);
}

///
/// fnSetEditingInfo : check whether lines are added or subtracted and do the work accordingly
///
function fnSetEditingInfo(idElement) {
    var textarea = $(idElement);
    var text = textarea.val();
    var currentLine = fnGetCaretPosition(idElement);
    var rowCount = text.split('\n').length;
    var addedRows = rowCount - editingInfo.rowCount;

    if (addedRows !== 0) {
        if (addedRows > 0) {
            fnAddRowsTable(addedRows);
        } else {
            fnDelRowsTable(addedRows);
        }
    }

    fnUpdateDataDetail();

    editingInfo.previousLine = currentLine;
    editingInfo.rowCount = rowCount;
}
function fnSetEditingInfoOld(idElement) {
    var textarea = $(idElement);
    var text = textarea.val();
    var currentLine = fnGetCaretPosition(idElement);
    var rowCount = text.split('\n').length;
    var addedRows = rowCount - editingInfo.rowCount;

    // perform extra data when adding rows
    if (addedRows > 0) {
        fnAddRowsTable(addedRows);
    }

    // perform data deletion when deleting lines
    if (addedRows < 0) {
        fnDelRowsTable(addedRows);
    }

    // after adding or deleting lines, the array needs to be reset
    fnUpdateDataDetail();

    editingInfo.previousLine = fnGetCaretPosition(idElement);
    editingInfo.rowCount = rowCount;
}

///
/// fnAddRowsTable
///
function fnAddRowsTable(addedRows) {
    var preLine = editingInfo.previousLine;
    var newData = [];

    for (var i = 0; i < addedRows; i++) {
        var seq = ('00' + (++preLine)).slice(-3);
        newData.push({
            seq: seq,
            textOrigin: '',
            buffer: ' ',
            alignment: optionAll.alignment || '0',
            highlight: optionAll.highlight || '0',
            etc: optionAll.etc || '0',
            ejs: optionAll.ejs || '0'
        });
    }

    if (addedRows > 0) {
        dataDetail.splice(preLine - addedRows + 1, 0, ...newData);
    }
}
function fnAddRowsTableOld(addedRows) {
    var preLine = editingInfo.previousLine;

    for (var i = 0; i < addedRows; i++) {
        var start = preLine;
        preLine += 1;
        var seq = ('00' + preLine).slice(-3);
        var data = {
            seq: seq,
            textOrigin: '',
            buffer: ' ',
            alignment: optionAll.alignment || '0',
            highlight: optionAll.highlight || '0',
            etc: optionAll.etc || '0',
            ejs: optionAll.ejs || '0'
        }
        dataDetail.splice(start, 0, data);
    }
}

///
/// fnDelRowsTable
///
function fnDelRowsTable(addedRows) {
    var curLine = editingInfo.currentLine;

    var start = curLine;
    var deleteCount = Math.abs(addedRows);

    dataDetail.splice(start, deleteCount);
}

///
/// fnUpdateDataDetail : update sequence and text information
///
function fnUpdateDataDetail() {
    var dataLength = dataDetail.length;
    for (var i = 0; i < dataLength; i++) {
        var data = dataDetail[i];
        var printLine = printLines[i];

        var buffer = fnFormatText(printLine, data.alignment, data.highlight, sizePerLine);

        var seq = ('00' + (i + 1)).slice(-3);
        var textOrigin = buffer.textOrigin;
        var bufferText = (data.etc === '2') ? barcode : buffer.text;

        Object.assign(data, { seq, textOrigin, buffer: bufferText });
    }
}
function fnUpdateDataDetailOld() {
    var dataLength = dataDetail.length;
    for (var i = 0; i < dataLength; i++) {
        var data = dataDetail[i];
        var printLine = printLines[i];

        var buffer = fnFormatText(printLine, data.alignment, data.highlight, sizePerLine);

        data.seq = ('00' + (i + 1)).slice(-3);
        data.textOrigin = buffer.textOrigin;
        data.buffer = data.etc === '2' ? barcode : buffer.text;
    }
}

///
/// fnCutTextSize : perform string slicing
/// params:
///    txtInput : text on line
/// return
///    text   : text after cutting
///    length : used for formatting in function fnFormatText
///
function fnCutTextSize(txtInput, width = 40) {
    var result = '';
    var count = 0;
    var dataLength = txtInput.length;
    for (var i = 0; i < dataLength; i++) {
        var char = txtInput[i];
        // check if the character has a Unicode code greater than 255 (not ASCII) to determine the length
        var length = (char.charCodeAt(0) > 255) ? 2 : 1;
        count += length;
        if (count > width) {
            break;
        }
        result += char;
    }

    return { text: result, length: count };
}
function fnCutTextSizeOld(txtInput, width = 40) {
    var result = '';
    var count = 0;
    var array = txtInput.split('');

    // split text
    for (var i = 0; i < array.length; i++) {
        var char = array[i];
        // used for the English alphabet = 1; used for Korean text length = 3
        var length = new Blob([char]).size;
        count += (length > 2 ? 2 : 1);
        if (count > width) {
            break;
        }
        result += char;
    }

    return { text: result, length: count};
}


///
/// fnFormatText : perform string slicing and text formatting according to options
/// params:
///    txtInput  : text on line
///    alignment : values('0', '1', '2')
///    highlight : values('0', '1', '2', '3', '4')
///    width     : maximum size per line
/// return
///    text       : text is formatted according to alignment and alignment
///    textOrigin : original text
///
function fnFormatText(txtInput, alignment = '0', highlight = '0', width = 40) {
    var array = txtInput.split('');
    if (highlight === '3' || highlight === '4') {
        width = Math.floor(width / 2);
    }

    var cutTextSize = fnCutTextSize(txtInput, width);
    var { text, length } = cutTextSize;
    var textOrigin = txtInput;
    var widthSpace = Math.max(0, width - length);

    if (alignment === '0') {
        text += ' '.repeat(widthSpace);
    } else if (alignment === '1') {
        var leftSpaces = Math.floor(widthSpace / 2);
        var rightSpaces = widthSpace - leftSpaces;
        text = ' '.repeat(leftSpaces) + text + ' '.repeat(rightSpaces);
    } else if (alignment === '2') {
        text = ' '.repeat(widthSpace) + text;
    }

    return { text, textOrigin };
}
function fnFormatTextOld(txtInput, alignment = '0', highlight = '0', width = 40) {
    var array = txtInput.split('');

    // DoubleW = 3 - DoubleWH = 4
    if (highlight === '3' || highlight === '4') {
        width = Math.floor(width / 2);
    }

    var cutTextSize = fnCutTextSize(txtInput, width);
    var textOrigin = txtInput;
    var result = cutTextSize.text;
    var count = cutTextSize.length;

    // Calculate the length of the missing space
    var widthSpace = width - count < 0 ? 0 : width - count;

    switch (alignment) {
        case '0':
            // Left alignment
            for (var i = 0; i < widthSpace; i++) {
                result = result + ' ';
            }
            break;
        case '1':
            // Center alignment
            widthSpace = Math.floor(widthSpace / 2);
            for (var i = 0; i < widthSpace; i++) {
                result = ' ' + result + ' ';
            }
            result += widthSpace % 2 === 0 ? '' : ' ';
            break;
        case '2':
            // Right alignment
            for (var i = 0; i < widthSpace; i++) {
                result = ' ' + result;
            }
            break;
        default:
            break;
    }

    return { text: result, textOrigin: textOrigin };
}

</script>

</body>
</html>
